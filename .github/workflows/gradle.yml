name: Java CI/CD with Gradle

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

concurrency:
  group: shared-server-deployment
  cancel-in-progress: false  # 실행 중인 job 취소하지 않고 대기

jobs:
  build-and-deploy:
    runs-on: self-hosted
    environment: order-cicd
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create application.yml from sample
        run: |
          cp src/main/resources/application-sample.yml src/main/resources/application.yml
          echo "application.yml created from sample"

      - name: Build with Gradle (including Testcontainers tests)
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          TOSS_BASE_URL: ${{secrets.TOSS_BASE_URL}}
          TOSS_SECRET_KEY: ${{secrets.TOSS_SECRET_KEY}}
          GEMINI_URL: ${{secrets.GEMINI_URL}}
          GEMINI_API_KEY: ${{secrets.GEMINI_API_KEY}}
          EAS_PASSPORT_SECRET_KEY: ${{secrets.EAS_PASSPORT_SECRET_KEY}}
          EAS_PASSPORT_EXPIRATION: ${{secrets.EAS_PASSPORT_EXPIRATION}}
          EAS_PASSPORT_ALGORITHM: ${{secrets.EAS_PASSPORT_ALGORITHM}}
          HUB_TOPIC: ${{secrets.HUB_TOPIC}}
          SHIPPING_MESSAGE_TOPIC: ${{secrets.SHIPPING_MESSAGE_TOPIC}}
          ORDER_TOPIC: ${{secrets.ORDER_TOPIC}}
          CONSUMER_GROUP_ID: ${{secrets.CONSUMER_GROUP_ID}}
          KAFKA_BOOTSTRAP: ${{secrets.KAFKA_BOOTSTRAP}}
          
          
          
        run: ./gradlew clean build

      - name: Stop existing application
        run: |
          echo "Stopping existing application on port ${{ secrets.APP_PORT }}..."
          PID=$(lsof -ti:${{ secrets.APP_PORT }}) || true
          if [ ! -z "$PID" ]; then
            echo "Found process $PID running on port ${{ secrets.APP_PORT }}"
            kill -15 $PID
            sleep 5
            if lsof -ti:${{ secrets.APP_PORT }} > /dev/null; then
              echo "Process still running, forcing kill..."
              kill -9 $(lsof -ti:${{ secrets.APP_PORT }})
            fi
            echo "Application stopped successfully"
          else
            echo "No application running on port ${{ secrets.APP_PORT }}"
          fi
      
      - name: Find executable jar
        run: |
          echo "=== list build/libs ==="
          ls -al build/libs

          # plain.jar는 제외하고, 실행 가능한 jar 하나 선택
          JAR_PATH=$(ls build/libs/*.jar | grep -v 'plain' | head -n 1)

          echo "Using JAR: $JAR_PATH"
          echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV
          
      - name: Deploy new version
        run: |
          JAR_PATH="${{ env.JAR_PATH }}"
          DEPLOY_DIR="$HOME/${{ secrets.DEPLOY_DIR }}"
          LOG_DIR="$HOME/${{ secrets.LOG_DIR }}"
          mkdir -p $LOG_DIR
          mkdir -p $DEPLOY_DIR
          
          if [ -f "$DEPLOY_DIR/app.jar" ]; then
            mv "$DEPLOY_DIR/app.jar" "$DEPLOY_DIR/app.jar.bak.$(date +%Y%m%d_%H%M%S)"
          fi
          
          cp "$JAR_PATH" "$DEPLOY_DIR/app.jar"
          echo "JAR deployed"

      - name: Update environment variables
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          TOSS_BASE_URL: ${{secrets.TOSS_BASE_URL}}
          TOSS_SECRET_KEY: ${{secrets.TOSS_SECRET_KEY}}
          GEMINI_URL: ${{secrets.GEMINI_URL}}
          GEMINI_API_KEY: ${{secrets.GEMINI_API_KEY}}
          EAS_PASSPORT_SECRET_KEY: ${{secrets.EAS_PASSPORT_SECRET_KEY}}
          EAS_PASSPORT_EXPIRATION: ${{secrets.EAS_PASSPORT_EXPIRATION}}
          EAS_PASSPORT_ALGORITHM: ${{secrets.EAS_PASSPORT_ALGORITHM}}
          HUB_TOPIC: ${{secrets.HUB_TOPIC}}
          SHIPPING_MESSAGE_TOPIC: ${{secrets.SHIPPING_MESSAGE_TOPIC}}
          ORDER_TOPIC: ${{secrets.ORDER_TOPIC}}
          CONSUMER_GROUP_ID: ${{secrets.CONSUMER_GROUP_ID}}
          KAFKA_BOOTSTRAP: ${{secrets.KAFKA_BOOTSTRAP}}
        run: |
          cat > $HOME/${{ secrets.DEPLOY_DIR }}/.env << EOF
          POSTGRES_HOST=${POSTGRES_HOST}
          POSTGRES_PORT=${POSTGRES_PORT}
          DB_USERNAME=${DB_USERNAME}
          DB_PASSWORD=${DB_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}
        
          TOSS_BASE_URL=${TOSS_BASE_URL}
          TOSS_SECRET_KEY=${TOSS_SECRET_KEY}
        
          GEMINI_URL=${GEMINI_URL}
          GEMINI_API_KEY=${GEMINI_API_KEY}
          
          EAS_PASSPORT_SECRET_KEY=${EAS_PASSPORT_SECRET_KEY}
          EAS_PASSPORT_EXPIRATION=${EAS_PASSPORT_EXPIRATION}
          EAS_PASSPORT_ALGORITHM=${EAS_PASSPORT_ALGORITHM}
        
          HUB_TOPIC=${HUB_TOPIC}
          SHIPPING_MESSAGE_TOPIC=${SHIPPING_MESSAGE_TOPIC}
          ORDER_TOPIC=${ORDER_TOPIC}
        
          CONSUMER_GROUP_ID=${CONSUMER_GROUP_ID}
          KAFKA_BOOTSTRAP=${KAFKA_BOOTSTRAP}
          EOF
          echo "Environment variables updated"

      - name: Restart application
        run: |
          $HOME/deploy/restart.sh ${{ secrets.APP_PORT }} ${{ secrets.DEPLOY_DIR }} ${{ secrets.LOG_DIR }}
          
          echo "Waiting for application to start..."
          sleep 10
          
          for i in {1..30}; do
            if lsof -ti:${{ secrets.APP_PORT }} > /dev/null 2>&1; then
              echo "Application is running on port ${{ secrets.APP_PORT }}"
              ps aux | grep app.jar | grep -v grep
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          echo "Application failed to start"
          tail -100 $HOME/${{ secrets.LOG_DIR }}/app.log
          exit 1

      - name: Verify deployment
        run: |
          sleep 5
          
          if lsof -ti:${{ secrets.APP_PORT }} > /dev/null; then
            echo "Deployment successful - Application is running on port ${{ secrets.APP_PORT }}"
          else
            echo "Deployment failed - Application is not running"
            tail -50 $HOME/${{ secrets.LOG_DIR }}/app.log
            exit 1
          fig
